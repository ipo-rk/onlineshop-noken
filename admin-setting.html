<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.7s cubic-bezier(.4, 2, .6, 1) both;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Setting</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-2xl mx-auto" x-data="adminSetting()">
        <div
            class="backdrop-blur-lg bg-white/70 border border-blue-100 rounded-3xl shadow-2xl p-10 relative overflow-hidden animate-fade-in">
            <div class="flex flex-col items-center mb-8">
                <div class="relative mb-2">
                    <label for="profileImageInput" class="cursor-pointer group block">
                        <template x-if="admin.profileImage">
                            <img :src="admin.profileImage" alt="Profile"
                                class="w-28 h-28 aspect-square object-cover rounded-full border-4 border-blue-400 shadow-lg transition group-hover:opacity-80"
                                style="min-width:7rem;min-height:7rem;max-width:7rem;max-height:7rem;" />
                        </template>
                        <template x-if="!admin.profileImage">
                            <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-full w-28 h-28 aspect-square flex items-center justify-center shadow-lg select-none"
                                style="min-width:7rem;min-height:7rem;max-width:7rem;max-height:7rem;">
                                <span class="text-white text-5xl font-bold"
                                    x-text="admin.name ? admin.name.charAt(0).toUpperCase() : '?'" />
                            </div>
                        </template>
                        <input id="profileImageInput" type="file" accept="image/*" class="hidden"
                            @change="updateProfileImage($event)">
                    </label>
                    <span class="block text-xs text-gray-500 text-center mt-1">Klik gambar untuk mengubah foto
                        profil</span>
                </div>
                <h1 class="text-4xl font-extrabold text-gray-800 mb-1 tracking-tight drop-shadow">Admin Setting</h1>
                <span class="text-base text-gray-500 font-medium">Kelola akun &amp; keamanan admin</span>
            </div>
            <form @submit.prevent="save" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Nama Admin</label>
                        <input type="text" x-model="admin.name"
                            class="w-full border-2 border-blue-200 rounded-xl px-4 py-3 bg-blue-50/60 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg transition placeholder-gray-400"
                            placeholder="Masukkan nama admin" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" x-model="admin.email"
                            class="w-full border-2 border-blue-200 rounded-xl px-4 py-3 bg-blue-50/60 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg transition placeholder-gray-400"
                            placeholder="Masukkan email" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Password</label>
                        <div class="relative">
                            <input :type="showPassword ? 'text' : 'password'" x-model="admin.password"
                                class="w-full border-2 border-blue-200 rounded-xl px-4 py-3 bg-blue-50/60 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg transition placeholder-gray-400 pr-12"
                                placeholder="Masukkan password" required>
                            <button type="button" @click="showPassword = !showPassword" tabindex="-1"
                                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 focus:outline-none">
                                <svg x-show="!showPassword" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg x-show="showPassword" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95m3.671-2.568A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.965 9.965 0 01-4.293 5.568M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 3l18 18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">No. HP</label>
                        <input type="text" x-model="admin.phone"
                            class="w-full border-2 border-blue-200 rounded-xl px-4 py-3 bg-blue-50/60 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg transition placeholder-gray-400"
                            placeholder="Masukkan nomor HP">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Alamat</label>
                    <textarea x-model="admin.address"
                        class="w-full border-2 border-blue-200 rounded-xl px-4 py-3 bg-blue-50/60 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg transition placeholder-gray-400"
                        placeholder="Masukkan alamat"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="submit"
                        class="px-8 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-400 text-white font-bold shadow-lg hover:from-blue-700 hover:to-blue-500 transition text-lg tracking-wide flex items-center gap-2">
                        <svg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' fill='none' viewBox='0 0 24 24'
                            stroke='currentColor'>
                            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7' />
                        </svg>
                        Simpan
                    </button>
                    <a href="dashboard.html"
                        class="px-8 py-3 rounded-xl bg-gray-200 text-gray-700 font-bold shadow hover:bg-gray-300 transition text-lg tracking-wide">Kembali</a>
                </div>
            </form>
            <template x-if="saved">
                <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                        <div class="mb-2 text-green-600 text-2xl">âœ”</div>
                        <div class="mb-2 font-semibold">Pengaturan berhasil disimpan!</div>
                        <button @click="saved = false" class="mt-2 px-4 py-1 rounded bg-blue-600 text-white"
                            href="dashboard.html">Tutup</button>
                    </div>
                </div>
            </template>
        </div>
    </div>
    <script>
        function adminSetting() {
            return {
                admin: {
                    id: '',
                    name: '',
                    email: '',
                    password: '',
                    phone: '',
                    address: '',
                    profileImage: ''
                },
                showPassword: false,
                saved: false,
                init() {
                    const admin = JSON.parse(localStorage.getItem('admin'));
                    if (admin) {
                        // Pastikan semua field ada
                        this.admin = Object.assign({
                            id: '', name: '', email: '', password: '', phone: '', address: '', profileImage: ''
                        }, admin);
                    }
                },
                updateProfileImage(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    // Validasi ukuran file asli (misal 1MB max, bisa diubah)
                    if (file.size > 1024 * 1024) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            text: 'Ukuran gambar terlalu besar (maksimal 1MB)!'
                        });
                        return;
                    }
                    // Kompres gambar ke max 200KB pakai canvas
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const maxDim = 256;
                            let w = img.width;
                            let h = img.height;
                            if (w > h) {
                                if (w > maxDim) { h *= maxDim / w; w = maxDim; }
                            } else {
                                if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                            }
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            // Kompres ke jpeg kualitas 0.7
                            let dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            // Validasi hasil kompresi max 200KB
                            function dataUrlSize(str) {
                                // base64 size = (length - 'data:image/jpeg;base64,'.length) * 3/4
                                return Math.round((str.length - 23) * 3 / 4);
                            }
                            if (dataUrlSize(dataUrl) > 200 * 1024) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Gagal',
                                    text: 'Gambar setelah kompres masih lebih dari 200KB! Pilih gambar lain.'
                                });
                                return;
                            }
                            this.admin.profileImage = dataUrl;
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                save() {
                    // Pastikan id admin tidak kosong
                    let adminData = Object.assign({
                        id: '', name: '', email: '', password: '', phone: '', address: '', profileImage: ''
                    }, this.admin);
                    if (!adminData.id || adminData.id.trim() === '') {
                        adminData.id = 'ADM-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
                    }
                    localStorage.setItem('admin', JSON.stringify(adminData));
                    // Update juga di array admins
                    let admins = JSON.parse(localStorage.getItem('admins')) || [];
                    const idx = admins.findIndex(a => a.id === adminData.id);
                    if (idx !== -1) {
                        admins[idx] = Object.assign({}, adminData);
                    } else {
                        admins.push(Object.assign({}, adminData));
                    }
                    localStorage.setItem('admins', JSON.stringify(admins));
                    // Update juga di app.js jika ada Alpine store global (opsional)
                    if (window.superAdminDashboard && typeof window.superAdminDashboard === 'function') {
                        if (window.Alpine && Alpine.store && Alpine.store('superAdminDashboard')) {
                            Alpine.store('superAdminDashboard').admins = admins;
                        }
                    }
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: 'Pengaturan berhasil disimpan',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = 'dashboard.html';
                    });
                }
            }
        }
    </script>
</body>

</html>